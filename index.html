<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-Cued Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Use Inter font for a cleaner look */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-8 flex flex-col gap-6">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-100">Voice-Cued Timer</h1>
            <p class="text-gray-400 mt-2">Say "set timer for 1 minute" after starting voice control.</p>
        </div>

        <div id="timerDisplay" class="text-7xl font-bold text-center tracking-wider py-4 text-gray-100">00:00</div>

        <div id="statusMessage" class="text-center text-gray-300 min-h-[40px]">
            Click 'Start Voice Control' to begin.
        </div>

        <div class="control-buttons flex flex-col sm:flex-row justify-center gap-4 mt-4">
            <button id="mainButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 ease-in-out shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-400">
                Start Voice Control
            </button>
            <button id="musicButton" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 ease-in-out shadow-lg focus:outline-none focus:ring-4 focus:ring-gray-500">
                Play Music
            </button>
        </div>
    </div>

    <audio id="backgroundMusic" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/11/22/audio_74c75521b1.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script>
        // --- DOM Elements ---
        const timerDisplay = document.getElementById('timerDisplay');
        const statusMessage = document.getElementById('statusMessage');
        const mainButton = document.getElementById('mainButton');
        const musicButton = document.getElementById('musicButton');
        const backgroundMusic = document.getElementById('backgroundMusic');

        // --- State Variables ---
        let totalSeconds = 0;
        let intervalId = null;
        let isPaused = false;
        let isRunning = false;
        let isMusicPlaying = false;

        // --- API Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        const synth = window.speechSynthesis;
        let audioContext;

        // --- 1. Browser Compatibility Check ---
        // This block checks if the browser supports the Web Speech API and disables the main button if it doesn't.
        if (!SpeechRecognition) {
            mainButton.textContent = "Not Supported";
            mainButton.disabled = true;
            statusMessage.textContent = "Voice control is not supported on this browser. Please try Chrome or Edge.";
        } else {
            recognition = new SpeechRecognition();
            recognition.continuous = false; // Process single, distinct commands
            recognition.lang = 'en-US';
        }

        // --- 2. Longer, More Pleasant Ding Sound ---
        // This function creates a richer, 2.5-second ding sound when the timer finishes.
        function playDingSound() {
            if (!audioContext) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(987.77, audioContext.currentTime); // B5 note for a brighter sound
            gainNode.gain.setValueAtTime(0.8, audioContext.currentTime);

            const dingDuration = 2.5; // Increased duration to 2.5 seconds
            gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + dingDuration);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + dingDuration);
        }

        // --- Core App Logic (Timer, Speech, etc.) ---
        function updateDisplay() {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function speak(text) {
            if (synth.speaking) synth.cancel();
            const utterThis = new SpeechSynthesisUtterance(text);
            synth.speak(utterThis);
        }

        function startTimer(duration) {
            clearInterval(intervalId);
            totalSeconds = duration;
            isRunning = true;
            isPaused = false;
            updateDisplay();
            mainButton.textContent = "Pause Timer";
            mainButton.disabled = false;

            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            let announcement = `Timer started for `;
            if (minutes > 0) announcement += `${minutes} minute${minutes > 1 ? 's' : ''}`;
            if (seconds > 0) announcement += ` ${seconds} second${seconds > 1 ? 's' : ''}`;
            
            statusMessage.textContent = announcement.trim() + '.';
            speak(announcement);

            intervalId = setInterval(() => {
                totalSeconds--;
                updateDisplay();
                if (totalSeconds <= 0) {
                    clearInterval(intervalId);
                    isRunning = false;
                    if (isMusicPlaying) {
                        backgroundMusic.pause();
                        isMusicPlaying = false;
                        musicButton.textContent = "Play Music";
                    }
                    statusMessage.innerHTML = "&#x1F389; Timer Finished! &#x1F389;"; // Confetti emoji
                    mainButton.textContent = "Start Voice Control";
                    mainButton.disabled = false;
                    playDingSound();
                    speak(`Your timer is finished.`);
                }
            }, 1000);
        }

        function togglePause() {
            if (!isRunning) return;
            isPaused = !isPaused;
            mainButton.textContent = isPaused ? "Resume Timer" : "Pause Timer";
            statusMessage.textContent = isPaused ? "Timer is paused." : "Timer resumed.";
            speak(isPaused ? "Paused." : "Resumed.");
        }

        function resetTimer() {
            clearInterval(intervalId);
            isRunning = false;
            isPaused = false;
            totalSeconds = 0;
            updateDisplay();
            mainButton.textContent = "Start Voice Control";
            mainButton.disabled = false;
            statusMessage.textContent = "Timer reset. Click to enable voice commands.";
            speak("Timer reset.");
        }

        function processVoiceCommand(command) {
            const timerMatch = command.match(/set timer for (\d+) (minute|second)s?/);
            if (timerMatch) {
                const value = parseInt(timerMatch[1], 10);
                const unit = timerMatch[2];
                const duration = unit === 'minute' ? value * 60 : value;
                startTimer(duration);
            } else if (command.includes('pause')) {
                togglePause();
            } else if (command.includes('resume')) {
                togglePause();
            } else if (command.includes('reset')) {
                resetTimer();
            } else {
                statusMessage.textContent = `Command not recognized. Try again.`;
                speak("Sorry, I didn't get that.");
            }
        }

        // --- Event Listeners ---
        if (recognition) {
            mainButton.addEventListener('click', () => {
                if (!audioContext) {
                    audioContext = new(window.AudioContext || window.webkitAudioContext)();
                }
                if (isRunning) {
                    togglePause();
                } else {
                    try {
                        recognition.start();
                    } catch (error) {
                        statusMessage.textContent = "Could not start listening. Please check permissions.";
                    }
                }
            });

            recognition.onstart = () => {
                mainButton.textContent = "Listening...";
                mainButton.disabled = true;
                statusMessage.textContent = "Say your command now...";
            };
            recognition.onresult = (event) => {
                const command = event.results[0][0].transcript.toLowerCase().trim();
                statusMessage.textContent = `Heard: "${command}"`;
                processVoiceCommand(command);
            };
            recognition.onend = () => {
                if (!isRunning) {
                    mainButton.textContent = "Start Voice Control";
                    mainButton.disabled = false;
                }
            };
            recognition.onerror = (event) => {
                if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    statusMessage.textContent = "Microphone access denied. Enable it in browser settings.";
                } else if (event.error === 'no-speech') {
                    statusMessage.textContent = "Didn't hear anything. Try again.";
                } else {
                    statusMessage.textContent = "An error occurred. Please try again.";
                }
            };
        }

        // --- 3. Music Button Listener ---
        // This handles the play/pause logic for the background music.
        musicButton.addEventListener('click', () => {
            if (!audioContext) {
                audioContext = new(window.AudioContext || window.webkitAudioContext)();
            }
            isMusicPlaying = !isMusicPlaying;
            if (isMusicPlaying) {
                backgroundMusic.play();
                musicButton.textContent = "Pause Music";
            } else {
                backgroundMusic.pause();
                musicButton.textContent = "Play Music";
            }
        });
    </script>
</body>
</html>
