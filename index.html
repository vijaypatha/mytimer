<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-Cued Timer</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general layout */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .timer-container {
            background-color: #2d3748; /* Slightly lighter dark for container */
            border-radius: 1.5rem; /* Rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); /* Darker shadow */
            padding: 2.5rem;
            max-width: 500px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .timer-display {
            font-size: 5rem; /* Large font for timer */
            font-weight: 700; /* Bold font */
            color: #e2e8f0; /* Light text for display */
            letter-spacing: 0.1em;
            margin-bottom: 1.5rem;
            min-height: 80px; /* Ensure consistent height */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .status-message {
            min-height: 40px; /* Ensure consistent height */
            color: #a0aec0; /* Lighter gray for status message */
            font-size: 1.1rem;
            margin-top: 1rem;
        }
        .control-buttons button {
            background-color: #667eea; /* Slightly brighter indigo for buttons */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* Rounded corners */
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.2);
            min-width: 180px; /* Ensure button has enough width for text */
        }
        .control-buttons button:hover {
            background-color: #5a67d8; /* Darker indigo on hover */
            transform: translateY(-2px);
        }
        .control-buttons button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }
        .control-buttons button:disabled {
            background-color: #4a5568; /* Darker gray for disabled buttons */
            color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
    </style>
</head>
<body>

    <div class="timer-container">
        <h1 class="text-3xl font-bold text-gray-100">Voice-Cued Timer</h1>
        <p class="text-gray-400">Say "start a timer for 5 minutes" or "set time for 1 min"</p>

        <div id="timerDisplay" class="timer-display">00:00</div>

        <div id="statusMessage" class="status-message">
            Click 'Start Voice & Timer' to begin.
        </div>

        <div class="control-buttons flex justify-center gap-4 mt-4">
            <button id="mainButton">Start Voice & Timer</button>
        </div>
    </div>

    <script>
    // Get DOM elements
    const timerDisplay = document.getElementById('timerDisplay');
    const statusMessage = document.getElementById('statusMessage');
    const mainButton = document.getElementById('mainButton');

    // Timer variables
    let totalSeconds = 0;
    let intervalId = null;
    let isPaused = false;
    let isRunning = false;
    let initialDurationSeconds = 0;

    // Speech Recognition setup
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const SpeechSynthesisUtterance = window.SpeechSynthesisUtterance;
    const synth = window.speechSynthesis;
    let recognition = null;
    let isRecognitionActive = false; // Flag to track recognition state

    // AudioContext for sound
    let audioContext = null;

    // --- Core Timer Functions ---

    function updateDisplay() {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function startTimer(durationInSeconds) {
        if (isRunning && !isPaused) return; // Already running

        // Clear any existing timer
        clearInterval(intervalId);

        totalSeconds = durationInSeconds;
        initialDurationSeconds = durationInSeconds;
        isRunning = true;
        isPaused = false;

        updateDisplay(); // Show initial time immediately
        mainButton.textContent = "Pause Timer";
        mainButton.disabled = false; // Enable button for pause control

        const minutes = Math.floor(durationInSeconds / 60);
        const seconds = durationInSeconds % 60;
        const startAnnouncement = `Timer started for ${minutes > 0 ? `${minutes} minutes` : ''} ${seconds > 0 ? `${seconds} seconds` : ''}.`;
        statusMessage.textContent = startAnnouncement;
        speak(startAnnouncement);

        intervalId = setInterval(() => {
            if (isPaused) return;

            totalSeconds--;
            updateDisplay();

            if (totalSeconds <= 0) {
                clearInterval(intervalId);
                isRunning = false;
                statusMessage.textContent = "Timer Finished!";
                mainButton.textContent = "Start Voice Recognition";
                mainButton.disabled = false; // Re-enable for starting voice again
                playDingSound();
                speak(`Your ${initialDurationSeconds >= 60 ? `${Math.floor(initialDurationSeconds/60)} minute` : `${initialDurationSeconds} second`} timer is finished.`);
            }
        }, 1000);
    }

    function pauseTimer() {
        if (!isRunning || isPaused) return;
        isPaused = true;
        mainButton.textContent = "Resume Timer";
        statusMessage.textContent = "Timer paused.";
        speak("Timer paused.");
    }

    function resumeTimer() {
        if (!isRunning || !isPaused) return;
        isPaused = false;
        mainButton.textContent = "Pause Timer";
        statusMessage.textContent = "Timer resumed.";
        speak("Timer resumed.");
    }

    function resetTimer() {
        clearInterval(intervalId);
        intervalId = null;
        totalSeconds = 0;
        initialDurationSeconds = 0;
        isPaused = false;
        isRunning = false;
        updateDisplay();
        mainButton.textContent = "Start Voice Recognition";
        mainButton.disabled = false;
        statusMessage.textContent = "Timer reset. Start voice recognition to set a new one.";
        speak("Timer reset.");
    }

    // --- Audio and Speech Functions ---

    function playDingSound() {
        if (!audioContext) return;
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
        gainNode.gain.setValueAtTime(1.0, audioContext.currentTime);
        oscillator.start();
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1.0);
        oscillator.stop(audioContext.currentTime + 1.0);
    }

    function speak(text) {
        if (synth.speaking) {
            synth.cancel();
        }
        const utterThis = new SpeechSynthesisUtterance(text);
        synth.speak(utterThis);
    }

    function initSpeechRecognition() {
        if (!SpeechRecognition) {
            statusMessage.textContent = "Speech Recognition not supported in this browser.";
            mainButton.disabled = true;
            return;
        }

        recognition = new SpeechRecognition();
        recognition.continuous = false; // Process single commands
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.onstart = () => {
            isRecognitionActive = true;
            mainButton.textContent = "Listening...";
            mainButton.disabled = true; // Disable while listening
            statusMessage.textContent = "Listening... Say a command.";
        };

        recognition.onresult = (event) => {
            const command = event.results[0][0].transcript.toLowerCase().trim();
            statusMessage.textContent = `Recognized: "${command}"`;
            processVoiceCommand(command);
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                statusMessage.textContent = "Microphone access denied. Please enable it in browser settings.";
            } else {
                statusMessage.textContent = "Error listening. Please try again.";
            }
        };

        recognition.onend = () => {
            isRecognitionActive = false;
            // Only re-enable the button if a timer is not actively running
            if (!isRunning) {
                mainButton.textContent = "Start Voice Recognition";
                mainButton.disabled = false;
            }
        };
    }

    function processVoiceCommand(command) {
        const startCommandMatch = command.match(/(?:start|set) (?:a )?timer for (\d+) (minute|second)s?/);

        if (startCommandMatch) {
            const value = parseInt(startCommandMatch[1]);
            const unit = startCommandMatch[2];
            const durationInSeconds = unit === 'minute' ? value * 60 : value;
            startTimer(durationInSeconds);
        } else if (command.includes('pause')) {
            pauseTimer();
        } else if (command.includes('resume')) {
            resumeTimer();
        } else if (command.includes('reset')) {
            resetTimer();
        } else {
            statusMessage.textContent = `Command not recognized. Try "set timer for 1 minute".`;
            speak("Sorry, I didn't recognize that command.");
        }
    }

    // --- Main Event Listener ---

    mainButton.addEventListener('click', () => {
        // 1. Initialize Audio on first interaction
        if (!audioContext) {
            audioContext = new(window.AudioContext || window.webkitAudioContext)();
        }

        // 2. Handle Timer controls if a timer is running
        if (isRunning) {
            if (isPaused) {
                resumeTimer();
            } else {
                pauseTimer();
            }
            return; // Stop further execution
        }

        // 3. Handle Voice Recognition if no timer is running
        if (!recognition) {
            initSpeechRecognition();
        }

        if (recognition && !isRecognitionActive) {
            try {
                recognition.start();
            } catch (e) {
                console.error("Could not start recognition:", e);
                statusMessage.textContent = "Could not start microphone. Check permissions.";
            }
        }
    });

    // Initial state setup
    window.onload = () => {
        mainButton.textContent = "Start Voice Recognition";
        statusMessage.textContent = "Click the button to enable voice commands.";
        updateDisplay(); // Set initial display to 00:00
    };
</script>
</body>
</html>
